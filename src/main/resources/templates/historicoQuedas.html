<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Verificador diario</title>
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    <link rel="stylesheet" type="text/css" th:href="@{/style.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/historicoQuedas.css}">
    <script src="/javascript.js"></script>
    <script th:src="@{/javascript.js}"></script>
    <link rel="icon" type="image/x-icon" href="/ico.png">
</head>

<body>
<div th:replace="~{header :: header}"></div>

<main>

    <input type="checkbox" id="toggle-switch" hidden>
    <label for="toggle-switch" class="toggle-label">
        <span class="option-one">Dia</span>
        <span class="option-two">Mês</span>
        <span class="toggle-slider"></span>
    </label>


    <div class="controleDia">
        <label for="calendario">Data:</label>
        <input
                type="date"
                id="calendario"
                name="calendario"
                th:value="${datas.getFirst()}"
                th:min="${datas.getLast()}"
                th:max="${datas.getFirst()}" />
        <button onclick="outraData()">GO</button>
        <div>
            <button onclick="diaHoje()">Hoje</button>
        </div>
    </div>

    <div class="controleMes">

        <select id="dropAno">
            <option th:each="ano : ${#numbers.sequence(datas.getLast().getYear(), datas.getFirst().getYear())}"
                    th:value="${ano}"
                    th:text="${ano}" ></option>
        </select>


        <select id="dropMes">
            <option th:each="mes : ${#numbers.sequence(0, 11)}"
                    th:value="${mes+1}"
                    th:text="${ #temporals.monthName(datas.getFirst().withMonth(mes+1)).substring(0,1).toUpperCase() +
                                #temporals.monthName(datas.getFirst().withMonth(mes+1)).substring(1)}"></option>
        </select>

        <button onclick="outroMes()">GO</button>

    </div>

    <div class="tituloBox">
        <button id="diaAntes" class="flechas" onclick="setasData(-1)">&lt;</button>
        <label th:text="${titulo}" id="titulo" style="font-size: larger; font-weight: bold;"></label>
        <button id="diaDepois" class="flechas" onclick="setasData(1)">&gt;</button>
    </div>

    <div id="count" style="margin: 15px 0;">Total de Quedas:</div>

    <table class="city" id="dataTable">
    <thead>
    <tr class="linha">
        <th>Cidade</th>
        <th>Data </th>
        <th>Tempo Fora</th>
        <th>Foi Queda de Luz?</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="queda : ${quedas}" class="linha">
        <td th:text="${queda.cidade}"></td>
        <td>
            <label th:text="${queda.data.toLocalDate()}"></label><br>
            <label th:text="${queda.data.toLocalTime()}"></label>
        </td>
        <td th:if="${queda.tempoFora.toSeconds() != 0}">
            <label th:text="'Horas: ' + ${queda.tempoFora.toHours()}"></label><br>
            <label th:text="'Minutos: ' + ${queda.tempoFora.toMinutesPart()}"></label>
        </td>
        <td th:unless="${queda.tempoFora.toSeconds() != 0}">
            <label>DOWN</label>
        </td>
        <td style="display: flex; align-items: center; justify-content: space-evenly;">
            <label class="checkFaltaDeLuz" th:value="${queda.faltaDeLuz}" ></label>
            <form action="/editaFaltaDeLuz" method="POST" >
                <input class="inputPequeno" type="text" th:value="${queda.id}" id="id" name="id" hidden="hidden">
                <input class="inputPequeno" type="text" th:value="${!queda.faltaDeLuz}" id="faltaDeLuz" name="faltaDeLuz" hidden="hidden">
                <input class="inputPequeno paginaAtual" type="text" value="" id="paginaAtual" name="paginaAtual" hidden="hidden">
                <button type="submit" style="float: right;" >Queda de Luz</button>
            </form>
        </td>

    </tr>
    </tbody>
    </table>

    <script>
        window.addEventListener('load', checksFaltaDeLuz);
        window.addEventListener('load', countLines);
        window.addEventListener('load', paginaAtualChecks);
        window.addEventListener('load', dadosSalvos);

        let dropAno = document.getElementById("dropAno");
        let dropMes = document.getElementById("dropMes");
        let calendario = document.getElementById("calendario");
        let switcher = document.getElementById("toggle-switch");

        function dadosSalvos() {
            const hoje = new Date();

            if (window.location.href.indexOf("mes") <= -1 &&
                window.location.href.indexOf("dia") <= -1){
                localStorage.clear();
            }

            if(localStorage.getItem('ano') == null){
                localStorage.setItem('ano', hoje.getFullYear());
                dropAno.value = hoje.getFullYear();
            }else{
                dropAno.value = parseInt(localStorage.getItem('ano'));
            }

            if(localStorage.getItem('mes') == null){
                localStorage.setItem('mes', hoje.getMonth()+1);
                dropMes.value = hoje.getMonth()+1;
            }else{
                dropMes.value = parseInt(localStorage.getItem('mes'));
            }

            if(localStorage.getItem('dia') == null){
                localStorage.setItem('dia', calendario.value);
            }else{
                calendario.value = localStorage.getItem('dia');
            }

            if(localStorage.getItem('switcher') == null){
                localStorage.setItem('switcher', false);
                switcher.checked = false;
            }else{
                switcher.checked = (localStorage.getItem('switcher') == "true");
            }
        }


        function paginaAtualChecks(){
            let paginaInputs = document.getElementsByClassName("paginaAtual");

            for(elem of paginaInputs){
                elem.value = window.location.pathname;
            }
        }

        function checksFaltaDeLuz(){
            let checks = document.getElementsByClassName("checkFaltaDeLuz");

            for(elem of checks){
                elem.innerText = (elem.getAttribute("value") == "true") ? '✅' : '❌';
            }
        }

        function atualizaSwitcher() {
            localStorage.setItem('switcher', switcher.checked);

            if(switcher.checked){
                outroMes()
            }else{
                outraData()
            }
        }
        switcher.addEventListener('change', atualizaSwitcher);

        function diaHoje(){
            let data = new Date();
            let hoje = data.toISOString().substring(0,10);

            localStorage.setItem('dia', hoje);
            window.location = '/historicoQuedas/dia/' + hoje;
        }

        function outraData(){
            localStorage.setItem('dia', calendario.value);
            window.location = '/historicoQuedas/dia/' + calendario.value;
        }

        function outroMes() {
            let inputMes = document.getElementById("dropMes");
            let inputAno = document.getElementById("dropAno");

            localStorage.setItem('mes', inputMes.value);
            localStorage.setItem('ano', inputAno.value);
            window.location = '/historicoQuedas/mes/' + inputAno.value + '/' + inputMes.value;
        }

        function setasData(valor){
            const hoje = new Date();

            if(switcher.checked){
                let mes = parseInt(localStorage.getItem('mes')) + valor;
                let ano = parseInt(localStorage.getItem('ano'));
                if(mes == 0){
                    mes = 12;
                    ano = ano - 1;
                }
                if(mes == 13){
                    mes = 1;
                    ano = ano + 1;
                }

                // se o ano for menor OK, se ano for igual confere mes
                if(ano < hoje.getFullYear() || (ano == hoje.getFullYear() && mes <= hoje.getMonth()+1)){
                    localStorage.setItem('mes', mes);
                    localStorage.setItem('ano', ano);
                    window.location = '/historicoQuedas/mes/' + ano + '/' + mes;
                }
            }else{
                let titulo = document.getElementById("titulo");
                let date = new Date(titulo.innerText + "T00:00:00.000Z");
                date.setDate(date.getDate() + valor);

                if(date <= hoje)
                    window.location = '/historicoQuedas/dia/' + date.toISOString().substring(0, 10);
            }

        }

        function countLines(){
            let table = document.getElementById("dataTable");
            let count = document.getElementById("count");
            let tr = table.getElementsByTagName("tr");

            count.innerText = count.innerText + ' ' + (tr.length - 1);
        }


    </script>

</main>

</body>

</html>